<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Alphaprime – Course Details</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* ===== BASE ===== */
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: #ffffff;
  color: #0a585b;
}
main {
  max-width: 1200px;
  margin: auto;
  padding: 40px 5%;
}

/* ===== HEADER & FOOTER (SAME AS LOGIN PAGE) ===== */
header, footer {
  background: linear-gradient(120deg, rgba(255,255,255,0.92), rgba(224,252,250,0.9));
}
footer {
  background:#0a585b;
  color:#fff;
  padding:30px;
  text-align:center;
  margin-top:60px;
}

/* ===== COURSE HERO ===== */
.course-hero {
  display:grid;
  grid-template-columns: 1.2fr 1fr;
  gap:30px;
  margin-bottom:40px;
}
.course-hero img {
  width:100%;
  border-radius:20px;
}
.course-hero h1 {
  margin-top:0;
}

/* ===== SECTIONS ===== */
.section-title {
  font-size:1.6rem;
  border-bottom:3px solid #0a585b;
  margin-bottom:20px;
  padding-bottom:6px;
}

/* ===== WHAT YOU WILL LEARN ===== */
.learn-list {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
  gap:14px;
}
.learn-item {
  background:#f1f8f7;
  padding:14px;
  border-radius:12px;
}

/* ===== TOPICS ===== */
.topic-card {
  border:1px solid #0a585b22;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}
.topic-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.topic-header h3 {
  margin:0;
}
.topic-duration {
  font-size:0.85rem;
  color:#0f766e;
}
.topic-desc {
  margin:10px 0;
}
.topic-video a {
  color:#0a585b;
  font-weight:600;
}

/* ===== RECOMMENDED COURSES ===== */
.recommended-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(260px,360px));
  gap:24px;
  justify-content:center;
}
.course-card {
  border:1px solid #0a585b22;
  border-radius:18px;
  padding:16px;
}
.course-card img {
  width:100%;
  border-radius:12px;
}
.course-card button {
  margin-top:10px;
  padding:8px 16px;
  border-radius:999px;
  border:2px solid #0a585b;
  background:#0a585b;
  color:#fff;
  cursor:pointer;
}
.course-card button:hover {
  background:#fff;
  color:#0a585b;
}
</style>
</head>

<body>

<!-- HEADER (reuse same header HTML if needed) -->
<header style="padding:16px;text-align:center;font-weight:700;">
  ALPHAPRIME · Learn · Trade · Grow
</header>

<main>

  <!-- COURSE HERO -->
  <section class="course-hero">
    <img id="courseImage">
    <div>
      <h1 id="courseTitle"></h1>
      <p id="courseDescription"></p>
    </div>
  </section>

  <!-- WHAT YOU WILL LEARN -->
  <section>
    <h2 class="section-title">What You Will Learn</h2>
    <div class="learn-list" id="learnList"></div>
  </section>

  <!-- COURSE CONTENT -->
  <section>
    <h2 class="section-title">Course Content</h2>
    <div id="topicsContainer"></div>
  </section>

  <!-- RECOMMENDED COURSES -->
  <section>
    <h2 class="section-title">Recommended Courses</h2>
    <div class="recommended-grid" id="recommendedContainer"></div>
  </section>

</main>

<footer>
  © 2025 Alphaprime. All rights reserved.
</footer>

<script>
/* =====================
   LOAD COURSE FROM BACKEND
===================== */
(async function(){
  const params = new URLSearchParams(window.location.search);
  const slug = params.get("slug");

  if (!slug) {
    document.body.innerHTML = "<h2>Course not found</h2>";
    return;
  }

  try {
    const res = await fetch(`/api/course/${encodeURIComponent(slug)}`);
    if (!res.ok) {
      document.body.innerHTML = "<h2>Course not found</h2>";
      return;
    }

    const payload = await res.json();
    if (!payload || !payload.success || !payload.course) {
      document.body.innerHTML = "<h2>Course not found</h2>";
      return;
    }

    const course = payload.course;

    /* HERO */
    document.getElementById("courseTitle").textContent = course.title || "";
    document.getElementById("courseDescription").textContent = course.description || "";
    const img = document.getElementById("courseImage");

    // Use database image_url directly
    let imgSrc = course.image_url;

    img.src = imgSrc;
    img.alt = course.title || "Course image";

    /* WHAT YOU WILL LEARN */
    const learnList = document.getElementById("learnList");
    learnList.innerHTML = "";

    // Flexible handling: API might return an array or newline-separated string
    const learnData = course.learn || course.what_you_learn || course.learnings || "";
    let learnItems = [];
    if (Array.isArray(learnData)) learnItems = learnData;
    else if (typeof learnData === 'string') learnItems = learnData.split("\n").map(s => s.trim()).filter(Boolean);

    if (learnItems.length) {
      learnItems.forEach(item => {
        const div = document.createElement("div");
        div.className = "learn-item";
        div.textContent = "✔ " + item;
        learnList.appendChild(div);
      });
    } else {
      document.getElementById("learnList").innerHTML = "<div class=\"learn-item\">Course curriculum will be added soon.</div>";
    }

    /* TOPICS (load from backend topics table) */
    const topicsContainer = document.getElementById("topicsContainer");
    topicsContainer.innerHTML = "";

    try {
      const topicsRes = await fetch(`/api/course/${encodeURIComponent(slug)}/topics`);
      if (topicsRes.ok) {
        const tp = await topicsRes.json();
        const topics = (tp && tp.success && Array.isArray(tp.topics)) ? tp.topics : [];

        if (topics.length) {
          topics.forEach(t => {
            const card = document.createElement("div");
            card.className = "topic-card";

            const durationText = (t.duration_minutes != null) ? `${t.duration_minutes} min` : (t.duration || '');
            const videoUrl = t.video_url || t.video || '#';
            const lockNotice = (t.unlocked === false) ? '<div style="color:#777;font-size:0.9rem">Locked</div>' : '';

            card.innerHTML = `
              <div class="topic-header">
                <h3>${t.title}</h3>
                <span class="topic-duration">${durationText}</span>
              </div>
              <p class="topic-desc">${t.description || ''}</p>
              <div class="topic-video">
                <a href="${videoUrl}" target="_blank">▶ Watch Video</a>
                ${lockNotice}
              </div>
            `;

            topicsContainer.appendChild(card);
          });
        } else {
          topicsContainer.innerHTML = "<p>No topics available yet for this course.</p>";
        }
      } else {
        topicsContainer.innerHTML = "<p>Could not load topics.</p>";
      }
    } catch (err) {
      console.warn('Error fetching topics', err);
      topicsContainer.innerHTML = "<p>Could not load topics.</p>";
    }

    /* RECOMMENDED COURSES (fetch from API) */
    const recommendedContainer = document.getElementById("recommendedContainer");
    recommendedContainer.innerHTML = "";

    try {
      const listRes = await fetch('/api/courses');
      if (listRes.ok) {
        const courses = await listRes.json();
        courses.forEach(c => {
          if (c.slug !== slug) {
            const card = document.createElement("div");
            card.className = "course-card";

            // Use database image_url or fallback to 4K image from collection
            let imgSrc = c.image_url;
            if (!imgSrc || imgSrc.includes('placeholder')) {
              // Use 4K image based on course slug
              imgSrc = courseImages[c.slug];
            }

            card.innerHTML = `
              <img src="${imgSrc}" alt="${(c.title || 'Course').replace(/"/g, '')}" loading="lazy">
              <h3>${c.title}</h3>
              <button onclick="location.href='course_details.html?slug=${c.slug}'">
                View Course
              </button>
            `;
            recommendedContainer.appendChild(card);
          }
        });
      }
    } catch (err) {
      // ignore recommended fetch failure
      console.warn('Could not fetch recommended courses', err);
    }

  } catch (err) {
    console.error(err);
    document.body.innerHTML = "<h2>Course not found</h2>";
  }
})();
</script>

</body>
</html>
